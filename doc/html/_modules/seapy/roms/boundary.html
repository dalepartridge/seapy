<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>seapy.roms.boundary &mdash; seapy 1.0a1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0a1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="seapy 1.0a1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">seapy 1.0a1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for seapy.roms.boundary</h1><div class="highlight"><pre>
<span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  boundary.py</span>

<span class="sd">  ROMS boundary utilities</span>

<span class="sd">  Written by Brian Powell on 01/15/14</span>
<span class="sd">  Copyright (c)2016 University of Hawaii under the BSD-License.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">seapy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="c1"># Define the sides of ROMS boundaries along with the DA ordering</span>
<span class="n">__side_info</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;__side_info&quot;</span><span class="p">,</span> <span class="s2">&quot;indices order slice&quot;</span><span class="p">)</span>
<span class="n">sides</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;west&quot;</span><span class="p">:</span> <span class="n">__side_info</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:],</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
         <span class="s2">&quot;south&quot;</span><span class="p">:</span> <span class="n">__side_info</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
         <span class="s2">&quot;east&quot;</span><span class="p">:</span> <span class="n">__side_info</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
         <span class="s2">&quot;north&quot;</span><span class="p">:</span> <span class="n">__side_info</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:]),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>


<div class="viewcode-block" id="from_roms"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.boundary.from_roms">[docs]</a><span class="k">def</span> <span class="nf">from_roms</span><span class="p">(</span><span class="n">roms_file</span><span class="p">,</span> <span class="n">bry_file</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a ROMS history, average, or climatology file, generate</span>
<span class="sd">    boundary conditions on the same grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    roms_file : string or list,</span>
<span class="sd">        ROMS source (history, average, climatology file)</span>
<span class="sd">    bry_file : string,</span>
<span class="sd">        output boundary file</span>
<span class="sd">    grid : seapy.model.grid or string, optional,</span>
<span class="sd">        ROMS grid for boundaries</span>
<span class="sd">    records : array, optional</span>
<span class="sd">        record indices to put into the boundary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">roms_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">ncroms</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf</span><span class="p">(</span><span class="n">roms_file</span><span class="p">)</span>
    <span class="n">src_ref</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_reftime</span><span class="p">(</span><span class="n">ncroms</span><span class="p">)</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">][:]))</span> \
        <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">records</span>

    <span class="c1"># Create the boundary file and fill up the descriptive data</span>
    <span class="n">ncbry</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_bry</span><span class="p">(</span><span class="n">bry_file</span><span class="p">,</span>
                                        <span class="n">eta_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">xi_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">,</span>
                                        <span class="n">s_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">reftime</span><span class="o">=</span><span class="n">src_ref</span><span class="p">,</span>
                                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;generated from &quot;</span> <span class="o">+</span> <span class="n">roms_file</span><span class="p">)</span>
    <span class="n">brytime</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_timevar</span><span class="p">(</span><span class="n">ncbry</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">ncbry</span><span class="p">)</span>
    <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;bry_time&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span>
        <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">][</span><span class="n">records</span><span class="p">],</span>
                         <span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
        <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">brytime</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bry</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;dims&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">bry</span><span class="p">))][:]</span> <span class="o">=</span> \
                        <span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">records</span><span class="p">,</span> <span class="p">:,</span>
                                              <span class="n">sides</span><span class="p">[</span><span class="n">bry</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">sides</span><span class="p">[</span><span class="n">bry</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">bry</span><span class="p">))][:]</span> <span class="o">=</span> \
                        <span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">records</span><span class="p">,</span>
                                              <span class="n">sides</span><span class="p">[</span><span class="n">bry</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">sides</span><span class="p">[</span><span class="n">bry</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ncbry</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="gen_ncks"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.boundary.gen_ncks">[docs]</a><span class="k">def</span> <span class="nf">gen_ncks</span><span class="p">(</span><span class="n">parent_file</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">sponge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the ncks commands for extracting a section of a global model</span>
<span class="sd">    that encompasses each of the boundaries of the given grid. The reason</span>
<span class="sd">    for this is that often we end up with massive global files, and we do</span>
<span class="sd">    not want to interpolate the entirety onto our regional grids (if our</span>
<span class="sd">    regional grid is large also), but only the boundary and nudge/sponge</span>
<span class="sd">    region.</span>

<span class="sd">    This script simply does the computation and outputs the necessary `ncks`</span>
<span class="sd">    commands that the user needs to produce global boundary region and</span>
<span class="sd">    boundary &quot;grid&quot; for the regional grid to then use in the interpolation</span>
<span class="sd">    (e.g., seapy.interp.to_clim). This is purely to save disk and cpu</span>
<span class="sd">    expense, and it is non-trivial to use.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent_file : seapy.model.grid or string,</span>
<span class="sd">        Parent file (HYCOM, etc.)</span>
<span class="sd">    grid : seapy.model.grid or string, optional,</span>
<span class="sd">        ROMS grid for boundaries</span>
<span class="sd">    sponge : int,</span>
<span class="sd">        Width to extract along each boundary. If 0, only the boundary itself</span>
<span class="sd">        will be extracted.</span>
<span class="sd">    pad : int,</span>
<span class="sd">        Additional rows/columns to extract from parent around the region</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">parent_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">parent_file</span><span class="p">)</span>
    <span class="n">child_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">fre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
    <span class="c1"># Make sure we are on the same coordinates</span>
    <span class="k">if</span> <span class="n">parent_grid</span><span class="o">.</span><span class="n">east</span><span class="p">()</span> <span class="o">!=</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">east</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">east</span><span class="p">():</span>
            <span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">360</span>

    <span class="c1"># Loop over each side of the grid and determine the indices from the</span>
    <span class="c1"># parent and child</span>
    <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
        <span class="c1"># Figure out which dimension this side is on and determine all</span>
        <span class="c1"># of the indices needed</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pdim</span> <span class="o">=</span> <span class="n">parent_grid</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;lat_rho&quot;</span><span class="p">]</span>
            <span class="n">cdim</span> <span class="o">=</span> <span class="s2">&quot;eta&quot;</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">sponge</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):,</span> <span class="p">:]</span>
                <span class="c1"># pdidx = &quot;{:d},&quot;.format(parent_grid.lat_rho.shape[0]-sponge-2)</span>
                <span class="n">cdidx</span> <span class="o">=</span> <span class="s2">&quot;{:d},&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">eta_rho</span> <span class="o">-</span> <span class="n">sponge</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:</span><span class="n">sponge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">cdidx</span> <span class="o">=</span> <span class="s2">&quot;,{:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sponge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">parent_grid</span><span class="o">.</span><span class="n">lat_rho</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span>
                <span class="n">parent_grid</span><span class="o">.</span><span class="n">lat_rho</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="n">idx</span><span class="p">])))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">pad</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">parent_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdim</span> <span class="o">=</span> <span class="n">parent_grid</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;lon_rho&quot;</span><span class="p">]</span>
            <span class="n">cdim</span> <span class="o">=</span> <span class="s2">&quot;xi&quot;</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">sponge</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):]</span>
                <span class="n">cdidx</span> <span class="o">=</span> <span class="s2">&quot;{:d},&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">xi_rho</span> <span class="o">-</span> <span class="n">sponge</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sponge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">cdidx</span> <span class="o">=</span> <span class="s2">&quot;,{:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sponge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span>
                <span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="n">idx</span><span class="p">])))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">pad</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">parent_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Put the indices together into strings for extracting out new files</span>
        <span class="n">pdidx</span> <span class="o">=</span> <span class="s2">&quot;{:d},{:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

        <span class="c1"># Display the commands:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;ncks&quot;</span>
        <span class="n">pfiles</span> <span class="o">=</span> <span class="s2">&quot;{:s} {:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent_grid</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">fre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_{:s}.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">side</span><span class="p">),</span>
                                            <span class="n">parent_grid</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">cfiles</span> <span class="o">=</span> <span class="s2">&quot;{:s} {:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">fre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_{:s}.nc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">side</span><span class="p">),</span>
                                            <span class="n">child_grid</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">grids</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_grid</span><span class="o">.</span><span class="n">cgrid</span><span class="p">:</span>
            <span class="n">pdim</span> <span class="o">=</span> <span class="s1">&#39; -d&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;{:s}_{:s},{:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pdim</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">pdidx</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdim</span> <span class="o">=</span> <span class="s2">&quot;{:s},{:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pdim</span><span class="p">,</span> <span class="n">pdidx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">cgrid</span><span class="p">:</span>
            <span class="n">cdim</span> <span class="o">=</span> <span class="s1">&#39; -d&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;{:s}_{:s},{:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdim</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">cdidx</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cdim</span> <span class="o">=</span> <span class="s2">&quot;{:s},{:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdim</span><span class="p">,</span> <span class="n">cdidx</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">side</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{:s} -O -d{:s} {:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pdim</span><span class="p">,</span> <span class="n">pfiles</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{:s} -O -d{:s} {:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cdim</span><span class="p">,</span> <span class="n">cfiles</span><span class="p">))</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="from_std"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.boundary.from_std">[docs]</a><span class="k">def</span> <span class="nf">from_std</span><span class="p">(</span><span class="n">std_filename</span><span class="p">,</span> <span class="n">bry_std_file</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the boundary standard deviations file for 4DVAR from the</span>
<span class="sd">    standard deviation of a boundary file. Best to use nco:</span>

<span class="sd">    $ ncwa -a bry_time roms_bry_file tmp.nc</span>

<span class="sd">    $ ncbo -O -y sub roms_bry_file tmp.nc tmp.nc</span>

<span class="sd">    $ ncra -y rmssdn tmp.nc roms_bry_std.nc</span>

<span class="sd">    to generate the standard deviations. This method simply takes the</span>
<span class="sd">    standard deviations of the boundaries and puts them into the</span>
<span class="sd">    proper format for ROMS 4DVAR.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    std_filename : string or list,</span>
<span class="sd">        Filename of the boundary standard deviation file</span>
<span class="sd">    bry_std_file : string,</span>
<span class="sd">        Filename of the boundary standard deviations file to create</span>
<span class="sd">    fields : list, optional,</span>
<span class="sd">        ROMS fields to generate boundaries for. The default are the</span>
<span class="sd">        standard fields as defined in seapy.roms.fields</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ncstd</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf</span><span class="p">(</span><span class="n">std_filename</span><span class="p">)</span>
    <span class="n">eta_rho</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncstd</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s2">&quot;eta_rho&quot;</span><span class="p">])</span>
    <span class="n">xi_rho</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncstd</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s2">&quot;xi_rho&quot;</span><span class="p">])</span>
    <span class="n">s_rho</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncstd</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s2">&quot;s_rho&quot;</span><span class="p">])</span>
    <span class="n">ncout</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_da_bry_std</span><span class="p">(</span><span class="n">bry_std_file</span><span class="p">,</span>
                                               <span class="n">eta_rho</span><span class="o">=</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">xi_rho</span><span class="o">=</span><span class="n">xi_rho</span><span class="p">,</span>
                                               <span class="n">s_rho</span><span class="o">=</span><span class="n">s_rho</span><span class="p">,</span>
                                               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;STD from &#39;</span> <span class="o">+</span> <span class="n">std_filename</span><span class="p">)</span>
    <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ocean_time&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ncstd</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;bry_time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">fields</span>

    <span class="c1"># Go over every side for every field and put it together</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;_obc&quot;</span>
        <span class="k">if</span> <span class="n">vname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s1">&#39;ocean_time&#39;</span><span class="p">,</span> <span class="s2">&quot;boundary&quot;</span><span class="p">,</span> <span class="s2">&quot;s_rho&quot;</span><span class="p">,</span> <span class="s2">&quot;IorJ&quot;</span><span class="p">))</span>
        <span class="n">ndat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bry</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">sides</span><span class="p">[</span><span class="n">bry</span><span class="p">]</span><span class="o">.</span><span class="n">order</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">ncstd</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">bry</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ndat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ndat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dat</span>
        <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ndat</span>
        <span class="n">ncout</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="gen_stations"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.boundary.gen_stations">[docs]</a><span class="k">def</span> <span class="nf">gen_stations</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a station file with stations at every boundary location for use in</span>
<span class="sd">    nesting one grid within another.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: string</span>
<span class="sd">        Input name of station file to create</span>
<span class="sd">    grid: string or seapy.model.grid</span>
<span class="sd">        Input grid to generate station file from. If string, it will open</span>
<span class="sd">        the grid file. If grid, it will use the grid information</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

    <span class="c1"># Put together the boundaries</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                          <span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                          <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">Npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>

<span class="s2">    ! Switch to control the writing of stations data within nested and/or multiple</span>
<span class="s2">    ! connected grids, [1:Ngrids].</span>

<span class="s2">       Lstations == T</span>

<span class="s2">    ! Logical switches (TRUE/FALSE) to activate writing of fields in STATION</span>
<span class="s2">    ! output file, [Sout(:,ng), ng=1, Ngrids].</span>

<span class="s2">    Sout(idUvel) == T       ! u                  3D U-velocity</span>
<span class="s2">    Sout(idVvel) == T       ! v                  3D V-velocity</span>
<span class="s2">    Sout(idWvel) == F       ! w                  3D W-velocity</span>
<span class="s2">    Sout(idOvel) == F       ! omega              3D omega vertical velocity</span>
<span class="s2">    Sout(idUbar) == T       ! ubar               2D U-velocity</span>
<span class="s2">    Sout(idVbar) == T       ! vbar               2D V-velocity</span>
<span class="s2">    Sout(idFsur) == T       ! zeta               free-surface</span>
<span class="s2">    Sout(idBath) == F       ! bath               time-dependent bathymetry</span>

<span class="s2">    Sout(idTvar) == T T     ! temp, salt, ...    all (NT) tracers</span>

<span class="s2">    Sout(idUsms) == F       ! sustr              surface U-stress</span>
<span class="s2">    Sout(idVsms) == F       ! svstr              surface V-stress</span>
<span class="s2">    Sout(idUbms) == F       ! bustr              bottom U-stress</span>
<span class="s2">    Sout(idVbms) == F       ! bvstr              bottom V-stress</span>

<span class="s2">    Sout(idUbrs) == F       ! bustrc             bottom U-current stress</span>
<span class="s2">    Sout(idVbrs) == F       ! bvstrc             bottom V-current stress</span>
<span class="s2">    Sout(idUbws) == F       ! bustrw             bottom U-wave stress</span>
<span class="s2">    Sout(idVbws) == F       ! bvstrw             bottom V-wave stress</span>
<span class="s2">    Sout(idUbcs) == F       ! bustrcwmax         bottom max wave-current U-stress</span>
<span class="s2">    Sout(idVbcs) == F       ! bvstrcwmax         bottom max wave-current V-stress</span>

<span class="s2">    Sout(idUbot) == F       ! Ubot               bed wave orbital U-velocity</span>
<span class="s2">    Sout(idVbot) == F       ! Vbot               bed wave orbital V-velocity</span>
<span class="s2">    Sout(idUbur) == F       ! Ur                 bottom U-velocity above bed</span>
<span class="s2">    Sout(idVbvr) == F       ! Vr                 bottom V-velocity above bed</span>

<span class="s2">    Sout(idW2xx) == F       ! Sxx_bar            2D radiation stress, Sxx component</span>
<span class="s2">    Sout(idW2xy) == F       ! Sxy_bar            2D radiation stress, Sxy component</span>
<span class="s2">    Sout(idW2yy) == F       ! Syy_bar            2D radiation stress, Syy component</span>
<span class="s2">    Sout(idU2rs) == F       ! Ubar_Rstress       2D radiation U-stress</span>
<span class="s2">    Sout(idV2rs) == F       ! Vbar_Rstress       2D radiation V-stress</span>
<span class="s2">    Sout(idU2Sd) == F       ! ubar_stokes        2D U-Stokes velocity</span>
<span class="s2">    Sout(idV2Sd) == F       ! vbar_stokes        2D V-Stokes velocity</span>

<span class="s2">    Sout(idW3xx) == F       ! Sxx                3D radiation stress, Sxx component</span>
<span class="s2">    Sout(idW3xy) == F       ! Sxy                3D radiation stress, Sxy component</span>
<span class="s2">    Sout(idW3yy) == F       ! Syy                3D radiation stress, Syy component</span>
<span class="s2">    Sout(idW3zx) == F       ! Szx                3D radiation stress, Szx component</span>
<span class="s2">    Sout(idW3zy) == F       ! Szy                3D radiation stress, Szy component</span>
<span class="s2">    Sout(idU3rs) == F       ! u_Rstress          3D U-radiation stress</span>
<span class="s2">    Sout(idV3rs) == F       ! v_Rstress          3D V-radiation stress</span>
<span class="s2">    Sout(idU3Sd) == F       ! u_stokes           3D U-Stokes velocity</span>
<span class="s2">    Sout(idV3Sd) == F       ! v_stokes           3D V-Stokes velocity</span>

<span class="s2">    Sout(idWamp) == F       ! Hwave              wave height</span>
<span class="s2">    Sout(idWlen) == F       ! Lwave              wave length</span>
<span class="s2">    Sout(idWdir) == F       ! Dwave              wave direction</span>
<span class="s2">    Sout(idWptp) == F       ! Pwave_top          wave surface period</span>
<span class="s2">    Sout(idWpbt) == F       ! Pwave_bot          wave bottom period</span>
<span class="s2">    Sout(idWorb) == F       ! Ub_swan            wave bottom orbital velocity</span>
<span class="s2">    Sout(idWdis) == F       ! Wave_dissip        wave dissipation</span>

<span class="s2">    Sout(idPair) == F       ! Pair               surface air pressure</span>
<span class="s2">    Sout(idUair) == F       ! Uair               surface U-wind component</span>
<span class="s2">    Sout(idVair) == F       ! Vair               surface V-wind component</span>

<span class="s2">    Sout(idTsur) == F F     ! shflux, ssflux     surface net heat and salt flux</span>
<span class="s2">    Sout(idLhea) == F       ! latent             latent heat flux</span>
<span class="s2">    Sout(idShea) == F       ! sensible           sensible heat flux</span>
<span class="s2">    Sout(idLrad) == F       ! lwrad              longwave radiation flux</span>
<span class="s2">    Sout(idSrad) == F       ! swrad              shortwave radiation flux</span>
<span class="s2">    Sout(idEmPf) == F       ! EminusP            E-P flux</span>
<span class="s2">    Sout(idevap) == F       ! evaporation        evaporation rate</span>
<span class="s2">    Sout(idrain) == F       ! rain               precipitation rate</span>

<span class="s2">    Sout(idDano) == F       ! rho                density anomaly</span>
<span class="s2">    Sout(idVvis) == F       ! AKv                vertical viscosity</span>
<span class="s2">    Sout(idTdif) == F       ! AKt                vertical T-diffusion</span>
<span class="s2">    Sout(idSdif) == F       ! AKs                vertical Salinity diffusion</span>
<span class="s2">    Sout(idHsbl) == F       ! Hsbl               depth of surface boundary layer</span>
<span class="s2">    Sout(idHbbl) == F       ! Hbbl               depth of bottom boundary layer</span>
<span class="s2">    Sout(idMtke) == F       ! tke                turbulent kinetic energy</span>
<span class="s2">    Sout(idMtls) == F       ! gls                turbulent length scale</span>

<span class="s2">    ! Logical switches (TRUE/FALSE) to activate writing of exposed sediment</span>
<span class="s2">    ! layer properties into STATIONS output file.  Currently, MBOTP properties</span>
<span class="s2">    ! are expected for the bottom boundary layer and/or sediment models:</span>
<span class="s2">    !</span>
<span class="s2">    ! idBott( 1=isd50)   grain_diameter          mean grain diameter</span>
<span class="s2">    ! idBott( 2=idens)   grain_density           mean grain density</span>
<span class="s2">    ! idBott( 3=iwsed)   settling_vel            mean settling velocity</span>
<span class="s2">    ! idBott( 4=itauc)   erosion_stres           critical erosion stress</span>
<span class="s2">    ! idBott( 5=irlen)   ripple_length           ripple length</span>
<span class="s2">    ! idBott( 6=irhgt)   ripple_height           ripple height</span>
<span class="s2">    ! idBott( 7=ibwav)   bed_wave_amp            wave excursion amplitude</span>
<span class="s2">    ! idBott( 8=izdef)   Zo_def                  default bottom roughness</span>
<span class="s2">    ! idBott( 9=izapp)   Zo_app                  apparent bottom roughness</span>
<span class="s2">    ! idBott(10=izNik)   Zo_Nik                  Nikuradse bottom roughness</span>
<span class="s2">    ! idBott(11=izbio)   Zo_bio                  biological bottom roughness</span>
<span class="s2">    ! idBott(12=izbfm)   Zo_bedform              bed form bottom roughness</span>
<span class="s2">    ! idBott(13=izbld)   Zo_bedload              bed load bottom roughness</span>
<span class="s2">    ! idBott(14=izwbl)   Zo_wbl                  wave bottom roughness</span>
<span class="s2">    ! idBott(15=iactv)   active_layer_thickness  active layer thickness</span>
<span class="s2">    ! idBott(16=ishgt)   saltation               saltation height</span>
<span class="s2">    !</span>
<span class="s2">    !                                 1 1 1 1 1 1 1</span>
<span class="s2">    !               1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6</span>

<span class="s2">    Sout(idBott) == F F F F F F F F F F F F F F F F</span>

<span class="s2">    ! Number of stations to process in each nested grid.  These values are</span>
<span class="s2">    ! essential because the station arrays are dynamically allocated using</span>
<span class="s2">    ! these values, [1:Ngrids].</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ! Station locations for all grids in any desired order.  The horizontal</span>
<span class="s2">    ! location for a particular station may be specified in terms of fractional</span>
<span class="s2">    ! (I,J) grid pairs (FLAG=0) or (longitude,latitude) grid pairs (FLAG=1).</span>
<span class="s2">    ! Here, FLAG is a special switch and may be used for multiple purposes.</span>
<span class="s2">    ! The GRID column indicates nested grid number to process. This value must</span>
<span class="s2">    ! be one in non-nested applications.  The COMMENT section is ignored during</span>
<span class="s2">    ! reading and may be used to help documentation.</span>

<span class="s2">    POS =  GRID  FLAG      X-POS       Y-POS     COMMENT</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">text_file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;! BOUNDARY STATIONS FOR GRID: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
              <span class="nb">file</span><span class="o">=</span><span class="n">text_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">text_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;        NSTATION ==  {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Npts</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">text_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">stations</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">text_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Npts</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;        1     1    {0:10.6f}   {1:10.6f}   BRY&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">lon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">file</span><span class="o">=</span><span class="n">text_file</span><span class="p">)</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="from_stations"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.boundary.from_stations">[docs]</a><span class="k">def</span> <span class="nf">from_stations</span><span class="p">(</span><span class="n">station_file</span><span class="p">,</span> <span class="n">bry_file</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a boundary forcing file from a stations file generated by a parent-grid.</span>
<span class="sd">    The stations.in file must have been generated by the seapy.roms.gen_stations method;</span>
<span class="sd">    otherwise, the order will be incorrect.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    station_file : string</span>
<span class="sd">        Filename of the stations file that is the source for the boundary data</span>
<span class="sd">    bry_file : string</span>
<span class="sd">        Filename of the boundary conditions file to generate</span>
<span class="sd">    grid : string or seapy.model.grid</span>
<span class="sd">        Grid that the boundary conditions are created for</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">ncstation</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">station_file</span><span class="p">)</span>
    <span class="n">src_ref</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_reftime</span><span class="p">(</span><span class="n">ncstation</span><span class="p">)</span>

    <span class="c1"># Create the boundary file and fill up the descriptive data</span>
    <span class="n">ncbry</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_bry</span><span class="p">(</span><span class="n">bry_file</span><span class="p">,</span>
                                        <span class="n">eta_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">xi_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">,</span>
                                        <span class="n">s_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">reftime</span><span class="o">=</span><span class="n">src_ref</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;generated from &quot;</span> <span class="o">+</span> <span class="n">station_file</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">ncbry</span><span class="p">)</span>

    <span class="c1"># Load the times: we need to see if the times are duplicated</span>
    <span class="c1"># because if using assimilation, they may be duplicated for every</span>
    <span class="c1"># outer-loop. Currently, it overwrites the first one each time (this</span>
    <span class="c1"># will need to be fixed if ROMS is fixed).</span>
    <span class="n">statime</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">][:]</span>
    <span class="n">dup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">statime</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">statime</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">dup</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dup</span><span class="p">)]</span>
        <span class="n">statime</span> <span class="o">=</span> <span class="n">statime</span><span class="p">[</span><span class="n">rng</span><span class="p">]</span>
    <span class="n">brytime</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_timevar</span><span class="p">(</span><span class="n">ncbry</span><span class="p">)</span>
    <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;bry_time&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span>
        <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">statime</span><span class="p">,</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
        <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">brytime</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="c1"># Set up the indices</span>
    <span class="n">bry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;south&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span>
        <span class="s2">&quot;north&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span>
        <span class="s2">&quot;west&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">lm</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">ln</span><span class="p">),</span>
        <span class="s2">&quot;east&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">lm</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">ln</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lm</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">ln</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1"># Get the information to construct the depths of the station data</span>
    <span class="n">sta_vt</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Vtransform&quot;</span><span class="p">][:]</span>
    <span class="n">sta_hc</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;hc&quot;</span><span class="p">][:]</span>
    <span class="n">sta_s_rho</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;s_rho&quot;</span><span class="p">][:]</span>
    <span class="n">sta_cs_r</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Cs_r&quot;</span><span class="p">][:]</span>
    <span class="n">sta_h</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">][:]</span>
    <span class="n">sta_angle</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">][:]</span>
    <span class="n">sta_lon</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon_rho&quot;</span><span class="p">][:]</span>
    <span class="n">sta_lat</span> <span class="o">=</span> <span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat_rho&quot;</span><span class="p">][:]</span>
    <span class="n">sta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sta_lat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sta_mask</span><span class="p">[</span><span class="n">sta_lon</span> <span class="o">*</span> <span class="n">sta_lat</span> <span class="o">&gt;</span> <span class="mf">1e10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Load the station data as we need to manipulate it</span>
    <span class="n">sta_zeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;zeta&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sta_ubar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ubar&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sta_vbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vbar&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sta_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sta_salt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;salt&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sta_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">sta_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ncstation</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">][</span><span class="n">rng</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ncstation</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Create the true positions and mask</span>
    <span class="n">grid_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">grid</span><span class="o">.</span><span class="n">h</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">h</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">grid_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                               <span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">grid_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                               <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">grid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                                <span class="n">grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">grid_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                                 <span class="n">grid</span><span class="o">.</span><span class="n">angle</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">angle</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># Search for bad stations due to child grid overlaying parent mask.</span>
    <span class="c1"># Unfortunately, ROMS will give points that are not at the locations</span>
    <span class="c1"># you specify if those points conflict with the mask. So, these points</span>
    <span class="c1"># are simply replaced with the nearest.</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sta_lon</span> <span class="o">-</span> <span class="n">grid_lon</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sta_lat</span> <span class="o">-</span> <span class="n">grid_lat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bad_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">grid_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">good_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">grid_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bad_pts</span><span class="p">:</span>
        <span class="n">didx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sta_lon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta_lon</span><span class="p">[</span><span class="n">good_pts</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="p">(</span><span class="n">sta_lat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">sta_lat</span><span class="p">[</span><span class="n">good_pts</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">good_pts</span><span class="p">[</span><span class="n">didx</span><span class="p">]</span>
        <span class="n">sta_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_h</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">sta_angle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_angle</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">sta_lon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_lon</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">sta_lat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_lat</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">sta_zeta</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_zeta</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span>
        <span class="n">sta_ubar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_ubar</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span>
        <span class="n">sta_vbar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_vbar</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span>
        <span class="n">sta_temp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sta_temp</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">sta_salt</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sta_salt</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">sta_u</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sta_u</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">sta_v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sta_v</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Construct the boundaries: a dictionary of boundary side and two element</span>
    <span class="c1"># array whether the u[0] or v[1] dimensions need to be averaged</span>
    <span class="n">sides</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;north&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span> <span class="s2">&quot;south&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span>
             <span class="s2">&quot;east&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">],</span> <span class="s2">&quot;west&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">]}</span>
    <span class="n">delta_angle</span> <span class="o">=</span> <span class="n">sta_angle</span> <span class="o">-</span> <span class="n">grid_angle</span>
    <span class="n">sta_ubar</span><span class="p">,</span> <span class="n">sta_vbar</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">sta_ubar</span><span class="p">,</span> <span class="n">sta_vbar</span><span class="p">,</span> <span class="n">delta_angle</span><span class="p">)</span>
    <span class="n">sta_u</span><span class="p">,</span> <span class="n">sta_v</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">sta_u</span><span class="p">,</span> <span class="n">sta_v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">delta_angle</span><span class="p">,</span>
                                                      <span class="p">(</span><span class="n">sta_u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Set up the parameters for depth-interpolated</span>
    <span class="n">wght</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="c1"># Build a non-extrapolating field to interpolate. Generate the</span>
    <span class="c1"># position and depth</span>
    <span class="k">def</span> <span class="nf">__expand_field</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">shp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">side</span><span class="p">)</span>

        <span class="c1"># Masks</span>
        <span class="n">sta_ocean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sta_mask</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ocean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">grid_mask</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If we have a masked boundary, skip it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ocean</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># 1) Zeta</span>
        <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;zeta_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][:,</span>
                                        <span class="n">ocean</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_zeta</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]][:,</span> <span class="n">ocean</span><span class="p">]</span>

        <span class="c1"># 2) Ubar</span>
        <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ubar_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">sta_ubar</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sta_ubar</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ubar_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">sta_ubar</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]]</span>

        <span class="c1"># 3) Vbar</span>
        <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vbar_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">sta_vbar</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sta_vbar</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vbar_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">sta_vbar</span><span class="p">[:,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]]</span>

        <span class="c1"># For 3D variables, we need to loop through time and interpolate</span>
        <span class="c1"># onto the child grid. Construct the distances</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]))</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">seapy</span><span class="o">.</span><span class="n">earth_distance</span><span class="p">(</span><span class="n">grid_lon</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                               <span class="n">grid_lat</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                               <span class="n">grid_lon</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">1</span><span class="p">:]],</span>
                                               <span class="n">grid_lat</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]))</span>
        <span class="n">sta_x</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">adddim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sta_s_rho</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">adddim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">s_rho</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">seapy</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">statime</span><span class="p">),</span> <span class="n">statime</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">sta_depth</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">depth</span><span class="p">(</span><span class="n">sta_vt</span><span class="p">,</span> <span class="n">sta_h</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]],</span> <span class="n">sta_hc</span><span class="p">,</span>
                                         <span class="n">sta_s_rho</span><span class="p">,</span> <span class="n">sta_cs_r</span><span class="p">,</span> <span class="n">sta_zeta</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]])</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">depth</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">vtransform</span><span class="p">,</span> <span class="n">grid_h</span><span class="p">[</span><span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]],</span>
                                     <span class="n">grid</span><span class="o">.</span><span class="n">hc</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">s_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">cs_r</span><span class="p">,</span> <span class="n">sta_zeta</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">]])</span>

            <span class="n">in_x</span> <span class="o">=</span> <span class="n">__expand_field</span><span class="p">(</span><span class="n">sta_x</span><span class="p">[:,</span> <span class="n">sta_ocean</span><span class="p">])</span>
            <span class="n">in_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3600</span>
            <span class="n">in_x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3600</span>
            <span class="n">in_depth</span> <span class="o">=</span> <span class="n">__expand_field</span><span class="p">(</span><span class="n">sta_depth</span><span class="p">[:,</span> <span class="n">sta_ocean</span><span class="p">])</span>
            <span class="n">in_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">in_depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mi">1000</span>
            <span class="n">in_depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">in_depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">10</span>

            <span class="c1"># 4) Temp</span>
            <span class="n">in_data</span> <span class="o">=</span> <span class="n">__expand_field</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">sta_temp</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">],</span> <span class="p">:][</span><span class="n">sta_ocean</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;temp_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;temp_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">pmap</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oa</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span>
                <span class="n">in_x</span><span class="p">,</span> <span class="n">in_depth</span><span class="p">,</span> <span class="n">in_data</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">depth</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">wght</span><span class="p">)</span>

            <span class="c1"># 5) Salt</span>
            <span class="n">in_data</span> <span class="o">=</span> <span class="n">__expand_field</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">sta_salt</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">],</span> <span class="p">:][</span><span class="n">sta_ocean</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;salt_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;salt_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">pmap</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oa</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span>
                <span class="n">in_x</span><span class="p">,</span> <span class="n">in_depth</span><span class="p">,</span> <span class="n">in_data</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">depth</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">pmap</span><span class="o">=</span><span class="n">pmap</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">wght</span><span class="p">)</span>

            <span class="c1"># 6) U</span>
            <span class="n">in_data</span> <span class="o">=</span> <span class="n">__expand_field</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">sta_u</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">],</span> <span class="p">:][</span><span class="n">sta_ocean</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">pmap</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oa</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">in_x</span><span class="p">,</span> <span class="n">in_depth</span><span class="p">,</span> <span class="n">in_data</span><span class="p">,</span>
                                                   <span class="n">x</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span>
                                                   <span class="n">depth</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span>
                                                   <span class="n">pmap</span><span class="o">=</span><span class="n">pmap</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">wght</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;u_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;u_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>

            <span class="c1"># 7) V</span>
            <span class="n">in_data</span> <span class="o">=</span> <span class="n">__expand_field</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">sta_v</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">bry</span><span class="p">[</span><span class="n">side</span><span class="p">],</span> <span class="p">:][</span><span class="n">sta_ocean</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">0</span>
            <span class="n">data</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span> <span class="n">pmap</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oa</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">in_x</span><span class="p">,</span> <span class="n">in_depth</span><span class="p">,</span> <span class="n">in_data</span><span class="p">,</span>
                                                   <span class="n">x</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span>
                                                   <span class="n">depth</span><span class="p">[:,</span> <span class="n">ocean</span><span class="p">],</span>
                                                   <span class="n">pmap</span><span class="o">=</span><span class="n">pmap</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span>
                                                   <span class="n">weight</span><span class="o">=</span><span class="n">wght</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;v_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncbry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;v_&quot;</span> <span class="o">+</span> <span class="n">side</span><span class="p">][</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">ncbry</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
    <span class="n">ncbry</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="detide"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.boundary.detide">[docs]</a><span class="k">def</span> <span class="nf">detide</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">bryfile</span><span class="p">,</span> <span class="n">tidefile</span><span class="p">,</span> <span class="n">tides</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a boundary file, detide the barotropic components and create tidal</span>
<span class="sd">    forcing file for the grid. This method will update the given boundary file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : seapy.model.grid or string,</span>
<span class="sd">    infile : string,</span>
<span class="sd">    outfile : string,</span>
<span class="sd">    tidefile : string,</span>
<span class="sd">    tides : string array,</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Make a long time-series boundary conditions from a group of boundary files,</span>
<span class="sd">    skipping the last record of each file to prevent overlap (if there are 100 records</span>
<span class="sd">    in each file). Afterwards, detide the resulting file.</span>

<span class="sd">    &gt;&gt;&gt; !ncrcat -dbry_time,0,,100,99 bry_out_*nc bry_detide.nc</span>
<span class="sd">    &gt;&gt;&gt; seapy.roms.boundary.detide(&quot;mygrid.nc&quot;, &quot;bry_detide.nc&quot;, &quot;tide_out.nc&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">datetime</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tides</span><span class="p">:</span>
        <span class="n">tides</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">tide</span><span class="o">.</span><span class="n">default_tides</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">tides</span><span class="p">)</span>

    <span class="c1"># Load Files</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">bry</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf</span><span class="p">(</span><span class="n">bryfile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="c1"># Get the definitions of the boundary file</span>
    <span class="n">epoch</span><span class="p">,</span> <span class="n">timevar</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_reftime</span><span class="p">(</span><span class="n">bry</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">timevar</span><span class="p">][:],</span>
                            <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">timevar</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="c1"># Pick the time for the tide file reference</span>
    <span class="n">tide_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">tide_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
        <span class="n">tide_start</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">tide_start</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">tide_start</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">s_rho</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bry</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;s_rho&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">s_rho</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">n</span>

    <span class="c1"># Set variables to detide</span>
    <span class="n">detide_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zeta&#39;</span><span class="p">,</span> <span class="s1">&#39;ubar&#39;</span><span class="p">,</span> <span class="s1">&#39;vbar&#39;</span><span class="p">]</span>

    <span class="c1"># Create the tide forcing file</span>
    <span class="n">tideout</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_tide</span><span class="p">(</span><span class="n">tidefile</span><span class="p">,</span> <span class="n">eta_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span>
                                           <span class="n">xi_rho</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">,</span>
                                           <span class="n">s_rho</span><span class="o">=</span><span class="n">s_rho</span><span class="p">,</span> <span class="n">ntides</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span>
                                           <span class="n">reftime</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                           <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Tides from &quot;</span> <span class="o">+</span> <span class="n">bryfile</span><span class="p">)</span>
    <span class="c1"># Set the tide periods and attributes</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_period&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">seapy</span><span class="o">.</span><span class="n">tide</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="n">tides</span><span class="p">)</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">tides</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tides</span><span class="p">)</span>
    <span class="n">bry</span><span class="o">.</span><span class="n">detide</span> <span class="o">=</span> <span class="s2">&quot;Detided to generate tide forcing: {:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tidefile</span><span class="p">)</span>

    <span class="c1"># Detide the free-surface</span>
    <span class="n">eamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">))</span>
    <span class="n">epha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">))</span>
    <span class="n">cmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">))</span>
    <span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">))</span>
    <span class="n">cang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">))</span>
    <span class="n">cpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tides</span><span class="p">),</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
        <span class="n">lvar</span> <span class="o">=</span> <span class="s2">&quot;zeta_&quot;</span> <span class="o">+</span> <span class="n">side</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">xi_rho</span> <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">slice</span> <span class="k">else</span> <span class="n">grid</span><span class="o">.</span><span class="n">eta_rho</span>
        <span class="k">if</span> <span class="n">lvar</span> <span class="ow">in</span> <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">lvar</span><span class="p">)</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">lvar</span><span class="p">][:])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">zeta</span><span class="p">)</span>
            <span class="c1"># Detide</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seapy</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">tide</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">zeta</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">tides</span><span class="o">=</span><span class="n">tides</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">tide_start</span><span class="o">=</span><span class="n">tide_start</span><span class="p">)</span>
                <span class="n">zeta</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">]</span>

                <span class="c1"># Save the amp/phase in the tide file</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tides</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">eamp</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">amp</span>
                        <span class="n">epha</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">eamp</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">amp</span>
                        <span class="n">epha</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

            <span class="c1"># Save out the detided information</span>
            <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">lvar</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">zeta</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bry</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

        <span class="c1"># Detide the barotropic velocity</span>
        <span class="n">uvar</span> <span class="o">=</span> <span class="s2">&quot;ubar_&quot;</span> <span class="o">+</span> <span class="n">side</span>
        <span class="n">vvar</span> <span class="o">=</span> <span class="s2">&quot;vbar_&quot;</span> <span class="o">+</span> <span class="n">side</span>
        <span class="k">if</span> <span class="n">uvar</span> <span class="ow">in</span> <span class="n">bry</span><span class="o">.</span><span class="n">variables</span> <span class="ow">and</span> <span class="n">vvar</span> <span class="ow">in</span> <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">uvar</span><span class="p">,</span> <span class="n">vvar</span><span class="p">)</span>
            <span class="n">ubar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">size</span><span class="p">))</span>
            <span class="n">vbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">size</span><span class="p">))</span>

            <span class="c1"># Load data, put onto rho-grid, and rotate</span>
            <span class="n">bubar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">uvar</span><span class="p">][:])</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">bvbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vvar</span><span class="p">][:])</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vbar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bvbar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bvbar</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">vbar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bvbar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">vbar</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bvbar</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ubar</span> <span class="o">=</span> <span class="n">bubar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ubar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bubar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bubar</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ubar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bubar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ubar</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bubar</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">vbar</span> <span class="o">=</span> <span class="n">bvbar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ubar</span><span class="p">,</span> <span class="n">vbar</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">ubar</span><span class="p">,</span> <span class="n">vbar</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">bubar</span> <span class="o">=</span> <span class="n">bvbar</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Detide</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seapy</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">tide</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">time</span><span class="p">,</span> <span class="n">ubar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">vbar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">tides</span><span class="o">=</span><span class="n">tides</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">tide_start</span><span class="o">=</span><span class="n">tide_start</span><span class="p">)</span>
                <span class="n">ubar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">])</span>
                <span class="n">vbar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">])</span>

                <span class="c1"># Save the amp/phase in the tide file</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tides</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cmax</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">amp</span>
                        <span class="n">cmin</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">amp</span>
                        <span class="n">cpha</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                        <span class="n">cang</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmax</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">amp</span>
                        <span class="n">cmin</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">amp</span>
                        <span class="n">cpha</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                        <span class="n">cang</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

            <span class="n">ubar</span><span class="p">,</span> <span class="n">vbar</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">ubar</span><span class="p">,</span> <span class="n">vbar</span><span class="p">,</span> <span class="o">-</span><span class="n">grid</span><span class="o">.</span><span class="n">angle</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vvar</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">vbar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">vbar</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">uvar</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ubar</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">uvar</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ubar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">ubar</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bry</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vvar</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">vbar</span>
            <span class="n">bry</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
            <span class="n">ubar</span> <span class="o">=</span> <span class="n">vbar</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Have to duplicate the boundary tide info into the inner row/column</span>
    <span class="n">eamp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eamp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">eamp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">eamp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eamp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eamp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eamp</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eamp</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">epha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">epha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">epha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">epha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">epha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">epha</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">epha</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">epha</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmax</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cmax</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmax</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmax</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmin</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cmin</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmin</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmin</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpha</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cpha</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpha</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cang</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cang</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cang</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Set the tide reference</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">tide_start</span> <span class="o">=</span> <span class="s2">&quot;Day {:5.1f} ({:s})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">tide_start</span> <span class="o">-</span>
                                                      <span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">,</span>
                                                     <span class="nb">str</span><span class="p">(</span><span class="n">tide_start</span><span class="p">))</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_Eamp&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">eamp</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_Ephase&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">epha</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_Cmax&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cmax</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_Cmin&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cmin</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_Cphase&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cpha</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tide_Cangle&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cang</span>
    <span class="n">tideout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">bry</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">pass</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">seapy 1.0a1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Powell Lab.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>