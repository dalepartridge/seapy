<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>seapy.roms.interp &mdash; seapy 1.0a1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0a1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="seapy 1.0a1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">seapy 1.0a1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for seapy.roms.interp</h1><div class="highlight"><pre>
<span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  roms.interp</span>

<span class="sd">  Methods to interpolate ROMS fields onto other grids</span>

<span class="sd">  Written by Brian Powell on 11/02/13</span>
<span class="sd">  Copyright (c)2016 University of Hawaii under the BSD-License.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">seapy</span>
<span class="kn">from</span> <span class="nn">seapy.timeout</span> <span class="kn">import</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">TimeoutError</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="n">_up_scaling</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;zeta&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;salt&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
<span class="n">_down_scaling</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;zeta&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">:</span> <span class="mf">0.98</span><span class="p">,</span> <span class="s2">&quot;salt&quot;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">}</span>
<span class="n">_ksize_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">_max_memory</span> <span class="o">=</span> <span class="mi">768</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>    <span class="c1"># Limit amount of memory to process in a single</span>
<span class="c1"># read. This determines how to divide up the</span>
<span class="c1"># time-records in interpolation</span>


<span class="k">def</span> <span class="nf">__mask_z_grid</span><span class="p">(</span><span class="n">z_data</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span> <span class="n">z_depth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When interpolating to z-grid, we need to apply depth dependent masking</span>
<span class="sd">    based on the original ROMS depths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">z_depth</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">src_depth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">z_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">z_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">z_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">__interp2_thread</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    internal routine: 2D interpolation thread for parallel interpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">fix_invalid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Convolve the water over the land</span>
    <span class="n">ksize</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">nx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rx</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                 <span class="p">(</span><span class="n">ny</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ry</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">ksize</span> <span class="o">&lt;</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;nx or ny values are too small for stable OA, {:f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ksize</span><span class="p">))</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ksize</span> <span class="o">&gt;</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;nx or ny values are too large for stable OA, {:f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ksize</span><span class="p">))</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">convolve_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">ksize</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Interpolate the field and return the result</span>
    <span class="k">with</span> <span class="n">timeout</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">9e4</span><span class="p">),</span> <span class="n">res</span><span class="p">,</span>
                              <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__interp3_thread</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span>
                     <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">up_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">down_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    internal routine: 3D interpolation thread for parallel interpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make the mask 3D</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">adddim</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">zz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">fix_invalid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># To avoid extrapolation, we are going to convolve ocean over the land</span>
    <span class="c1"># and add a new top and bottom layer that replicates the data of the</span>
    <span class="c1"># existing current and top. 1) iteratively convolve until we have</span>
    <span class="c1"># filled most of the points, 2) Determine which way the</span>
    <span class="c1"># depth goes and add/subtract new layers, and 3) fill in masked values</span>
    <span class="c1"># from the layer above/below.</span>
    <span class="n">gradsrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Convolve the water over the land</span>
    <span class="n">ksize</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">nx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rx</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                 <span class="p">(</span><span class="n">ny</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ry</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">ksize</span> <span class="o">&lt;</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;nx or ny values are too small for stable OA, {:f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ksize</span><span class="p">))</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ksize</span> <span class="o">&gt;</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;nx or ny values are too large for stable OA, {:f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ksize</span><span class="p">))</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="n">_ksize_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Iterate at most 5 times, but we will hopefully break out before that by</span>
    <span class="c1"># checking if we have filled at least 40% of the bottom to be like</span>
    <span class="c1"># the surface</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">gradsrc</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">top</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">gradsrc</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">topmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">top</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">bot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="c1"># Check if we have most everything by checking the bottom</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">convolve_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">ksize</span> <span class="o">+</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">topmask</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">bot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="c1"># Now fill vertically</span>
    <span class="n">nrz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">nrz</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rz</span>
    <span class="n">nrz</span><span class="p">[</span><span class="n">bot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rz</span><span class="p">[</span><span class="n">bot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mi">500</span>
    <span class="n">nrz</span><span class="p">[</span><span class="n">top</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rz</span><span class="p">[</span><span class="n">top</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gradsrc</span><span class="p">:</span>
        <span class="c1"># The first level is the bottom</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">down_factor</span>
        <span class="c1"># # Fill in missing values where we have them from above (level above)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                            <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The first level is the top</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">up_factor</span>
        <span class="c1"># # Fill in missing values where we have them from below (level below)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                            <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">factor</span>

    <span class="c1"># Add upper and lower boundaries</span>
    <span class="n">ndat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">ndat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
    <span class="n">ndat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">ndat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>

    <span class="c1"># Interpolate the field and return the result</span>
    <span class="k">with</span> <span class="n">timeout</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gradsrc</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oavol</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">nrz</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">ndat</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                  <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oavol</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">nrz</span><span class="p">,</span> <span class="n">ndat</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span>
                                  <span class="n">pmap</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">9e4</span><span class="p">),</span> <span class="n">res</span><span class="p">,</span>
                              <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__interp3_vel_thread</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">za</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span>
                         <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    internal routine: 3D velocity interpolation thread for parallel interpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Put on the same grid</span>
    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">u2rho</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">v2rho</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Rotate the fields (NOTE: ROMS angle is negative relative to &quot;true&quot;)</span>
    <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">ra</span><span class="p">)</span>

    <span class="c1"># Interpolate</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">__interp3_thread</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span>
                         <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">_up_scaling</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span>
                         <span class="n">_down_scaling</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">__interp3_thread</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span>
                         <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">_up_scaling</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span>
                         <span class="n">_down_scaling</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">])</span>

    <span class="c1"># Rotate to destination (NOTE: ROMS angle is negative relative to &quot;true&quot;)</span>
    <span class="k">if</span> <span class="n">za</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="n">za</span><span class="p">)</span>

    <span class="c1"># Return the masked data</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span>


<span class="k">def</span> <span class="nf">__interp_grids</span><span class="p">(</span><span class="n">src_grid</span><span class="p">,</span> <span class="n">child_grid</span><span class="p">,</span> <span class="n">ncout</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">z_mask</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">pmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    internal method:  Given a model file (average, history, etc.),</span>
<span class="sd">    interpolate the fields onto another gridded file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_grid : seapy.model.grid data source (History, Average, etc. file)</span>
<span class="sd">    child_grid : seapy.model.grid output data grid</span>
<span class="sd">    ncout : netcdf output file</span>
<span class="sd">    [records] : array of the record indices to interpolate</span>
<span class="sd">    [threads] : number of processing threads</span>
<span class="sd">    [nx] : decorrelation length in grid-cells for x</span>
<span class="sd">    [ny] : decorrelation length in grid-cells for y</span>
<span class="sd">    [vmap] : variable name mapping</span>
<span class="sd">    [z_mask] : mask out depths in z-grids</span>
<span class="sd">    [pmap] : use the specified pmap rather than compute it</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If we don&#39;t have a variable map, then do a one-to-one mapping</span>
    <span class="k">if</span> <span class="n">vmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">vmap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>

    <span class="c1"># Generate a file to store the pmap information</span>
    <span class="n">sname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src_grid</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">cname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">child_grid</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">pmap_file</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">cname</span><span class="p">))</span> <span class="k">else</span> \
        <span class="n">sname</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">cname</span> <span class="o">+</span> <span class="s2">&quot;_pmap.npz&quot;</span>

    <span class="c1"># Create or load the pmaps depending on if they exist</span>
    <span class="k">if</span> <span class="n">nx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src_grid</span><span class="p">,</span> <span class="s2">&quot;dm&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child_grid</span><span class="p">,</span> <span class="s2">&quot;dm&quot;</span><span class="p">):</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">dm</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">ny</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src_grid</span><span class="p">,</span> <span class="s2">&quot;dn&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child_grid</span><span class="p">,</span> <span class="s2">&quot;dn&quot;</span><span class="p">):</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">dn</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">dn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">if</span> <span class="n">pmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pmap_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pmap_file</span><span class="p">):</span>
            <span class="n">pmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pmap_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">pmaprho</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                        <span class="n">tmp</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                        <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">mask_u</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">pmapu</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">lon_u</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_u</span><span class="p">,</span>
                                      <span class="n">tmp</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                      <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">mask_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">pmapv</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">lon_v</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_v</span><span class="p">,</span>
                                      <span class="n">tmp</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                      <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pmap_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">pmap_file</span><span class="p">,</span> <span class="n">pmaprho</span><span class="o">=</span><span class="n">pmaprho</span><span class="p">,</span> <span class="n">pmapu</span><span class="o">=</span><span class="n">pmapu</span><span class="p">,</span> <span class="n">pmapv</span><span class="o">=</span><span class="n">pmapv</span><span class="p">)</span>
            <span class="n">pmap</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pmaprho&quot;</span><span class="p">:</span> <span class="n">pmaprho</span><span class="p">,</span> <span class="s2">&quot;pmapu&quot;</span><span class="p">:</span> <span class="n">pmapu</span><span class="p">,</span> <span class="s2">&quot;pmapv&quot;</span><span class="p">:</span> <span class="n">pmapv</span><span class="p">}</span>

    <span class="c1"># Get the time field</span>
    <span class="n">ncsrc</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf4</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_timevar</span><span class="p">(</span><span class="n">ncsrc</span><span class="p">)</span>

    <span class="c1"># Interpolate the depths from the source to final grid</span>
    <span class="n">src_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">dst_depth</span> <span class="o">=</span> <span class="n">__interp2_thread</span><span class="p">(</span><span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span>
                                 <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span> <span class="n">pmap</span><span class="p">[</span>
                                     <span class="s2">&quot;pmaprho&quot;</span><span class="p">],</span>
                                 <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">)</span>
    <span class="c1"># Interpolate the scalar fields</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
        <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">vmap</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>

        <span class="c1"># Extra fields will probably be user tracers (biogeochemical)</span>
        <span class="n">fld</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dims&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

        <span class="c1"># Only interpolate the fields we want in the destination</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;rotate&quot;</span> <span class="ow">in</span> <span class="n">fld</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">fld</span><span class="p">[</span><span class="s2">&quot;dims&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Compute the max number of hold in memory</span>
            <span class="n">maxrecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">_max_memory</span> <span class="o">/</span> <span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span>
                                                                     <span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">nbytes</span><span class="p">))))</span>
            <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="n">recs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seapy</span><span class="o">.</span><span class="n">chunker</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">maxrecs</span><span class="p">)):</span>
                <span class="n">outr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span>
                    <span class="n">rn</span> <span class="o">*</span> <span class="n">maxrecs</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">((</span><span class="n">rn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">maxrecs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">))]</span>
                <span class="n">ndata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                                    <span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">__interp2_thread</span><span class="p">)(</span>
                                     <span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                     <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                     <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                     <span class="n">pmap</span><span class="p">[</span><span class="s2">&quot;pmaprho&quot;</span><span class="p">],</span> <span class="n">weight</span><span class="p">,</span>
                                     <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">dest</span><span class="p">][</span><span class="n">outr</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ndata</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxrecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">_max_memory</span> <span class="o">/</span> <span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span>
                                                                     <span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">n</span><span class="p">))))</span>
            <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="n">recs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seapy</span><span class="o">.</span><span class="n">chunker</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">maxrecs</span><span class="p">)):</span>
                <span class="n">outr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span>
                    <span class="n">rn</span> <span class="o">*</span> <span class="n">maxrecs</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">((</span><span class="n">rn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">maxrecs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">))]</span>
                <span class="n">ndata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                                    <span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">__interp3_thread</span><span class="p">)(</span>
                                        <span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                        <span class="n">src_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">,</span>
                                        <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                                        <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                                        <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">,</span>
                                        <span class="n">pmap</span><span class="p">[</span><span class="s2">&quot;pmaprho&quot;</span><span class="p">],</span> <span class="n">weight</span><span class="p">,</span>
                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">,</span>
                                        <span class="n">up_factor</span><span class="o">=</span><span class="n">_up_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                                        <span class="n">down_factor</span><span class="o">=</span><span class="n">_down_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z_mask</span><span class="p">:</span>
                    <span class="n">__mask_z_grid</span><span class="p">(</span><span class="n">ndata</span><span class="p">,</span> <span class="n">dst_depth</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">)</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">dest</span><span class="p">][</span><span class="n">outr</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ndata</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

    <span class="c1"># Rotate and Interpolate the vector fields. First, determine which</span>
    <span class="c1"># are the &quot;u&quot; and the &quot;v&quot; vmap fields</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">velmap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">list</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">)],</span>
            <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">list</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)]}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;velocity not present in source file&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">srcangle</span> <span class="o">=</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">angle</span> <span class="k">if</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">cgrid</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">dstangle</span> <span class="o">=</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">angle</span> <span class="k">if</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">cgrid</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">maxrecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">_max_memory</span> <span class="o">/</span>
                                              <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span>
                                                    <span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">n</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">recs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seapy</span><span class="o">.</span><span class="n">chunker</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">maxrecs</span><span class="p">)):</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> \
            <span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">__interp3_vel_thread</span><span class="p">)(</span>
                <span class="n">src_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">src_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                <span class="n">src_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">,</span> <span class="n">srcangle</span><span class="p">,</span>
                <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">velmap</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">velmap</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">child_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">,</span>
                <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">,</span> <span class="n">dstangle</span><span class="p">,</span>
                <span class="n">pmap</span><span class="p">[</span><span class="s2">&quot;pmaprho&quot;</span><span class="p">],</span> <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span>
                <span class="n">child_grid</span><span class="o">.</span><span class="n">mask_rho</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vel</span><span class="p">)):</span>
            <span class="n">vel_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">vel_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z_mask</span><span class="p">:</span>
                <span class="n">__mask_z_grid</span><span class="p">(</span><span class="n">vel_u</span><span class="p">,</span> <span class="n">dst_depth</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">)</span>
                <span class="n">__mask_z_grid</span><span class="p">(</span><span class="n">vel_v</span><span class="p">,</span> <span class="n">dst_depth</span><span class="p">,</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_rho</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">cgrid</span><span class="p">:</span>
                <span class="n">vel_u</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rho2u</span><span class="p">(</span><span class="n">vel_u</span><span class="p">)</span>
                <span class="n">vel_v</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rho2v</span><span class="p">(</span><span class="n">vel_v</span><span class="p">)</span>

            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">][</span><span class="n">nr</span> <span class="o">*</span> <span class="n">maxrecs</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vel_u</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">][</span><span class="n">nr</span> <span class="o">*</span> <span class="n">maxrecs</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vel_v</span>

            <span class="k">if</span> <span class="s2">&quot;ubar&quot;</span> <span class="ow">in</span> <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="c1"># Create ubar and vbar</span>
                <span class="c1"># depth = seapy.adddim(child_grid.depth_u, vel_u.shape[0])</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ubar&quot;</span><span class="p">][</span><span class="n">nr</span> <span class="o">*</span> <span class="n">maxrecs</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vel_u</span> <span class="o">*</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span>  \
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">depth_u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;vbar&quot;</span> <span class="ow">in</span> <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="c1"># depth = seapy.adddim(child_grid.depth_v, vel_v.shape[0])</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vbar&quot;</span><span class="p">][</span><span class="n">nr</span> <span class="o">*</span> <span class="n">maxrecs</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vel_v</span> <span class="o">*</span> <span class="n">child_grid</span><span class="o">.</span><span class="n">depth_v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span>  \
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">child_grid</span><span class="o">.</span><span class="n">depth_v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">ncout</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

    <span class="c1"># Return the pmap that was used</span>
    <span class="k">return</span> <span class="n">pmap</span>


<div class="viewcode-block" id="field2d"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.interp.field2d">[docs]</a><span class="k">def</span> <span class="nf">field2d</span><span class="p">(</span><span class="n">src_lon</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span> <span class="n">src_field</span><span class="p">,</span> <span class="n">dest_lon</span><span class="p">,</span> <span class="n">dest_lat</span><span class="p">,</span> <span class="n">dest_mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">nx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a 2D field with time (dimensions [time, lat, lon]), interpolate</span>
<span class="sd">    onto a new grid and return the new field. This is a helper function</span>
<span class="sd">    when needing to interpolate data within files, etc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_lon: numpy.ndarray</span>
<span class="sd">        longitude that field is on</span>
<span class="sd">    src_lat: numpy.ndarray</span>
<span class="sd">        latitude that field is on</span>
<span class="sd">    src_field: numpy.ndarray</span>
<span class="sd">        field to interpolate</span>
<span class="sd">    dest_lon: numpy.ndarray</span>
<span class="sd">        output longitudes to interpolate to</span>
<span class="sd">    dest_lat: numpy.ndarray</span>
<span class="sd">        output latitudes to interpolate to</span>
<span class="sd">    dest_mask: numpy.ndarray, optional</span>
<span class="sd">        mask to apply to interpolated data</span>
<span class="sd">    reftime: datetime, optional:</span>
<span class="sd">        Reference time as the epoch for z-grid file</span>
<span class="sd">    nx : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    ny : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    weight : int, optional:</span>
<span class="sd">        number of points to use in weighting matrix</span>
<span class="sd">    threads : int, optional:</span>
<span class="sd">        number of processing threads</span>
<span class="sd">    pmap : numpy.ndarray, optional:</span>
<span class="sd">        use the specified pmap rather than compute it</span>

<span class="sd">    Output</span>
<span class="sd">    ------</span>
<span class="sd">    ndarray:</span>
<span class="sd">        interpolated field on the destination grid</span>
<span class="sd">    pmap:</span>
<span class="sd">        the pmap used in the inerpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">tmp</span><span class="p">,</span> <span class="n">pmap</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">src_lon</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span>
                                 <span class="n">dest_lon</span><span class="p">,</span> <span class="n">dest_lat</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dest_mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dest_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dest_lat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">maxrecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">_max_memory</span> <span class="o">/</span> <span class="p">(</span><span class="n">dest_lon</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">src_lon</span><span class="o">.</span><span class="n">nbytes</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="n">recs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seapy</span><span class="o">.</span><span class="n">chunker</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">maxrecs</span><span class="p">)):</span>
        <span class="n">nfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                             <span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">__interp2_thread</span><span class="p">)(</span>
                                 <span class="n">src_lon</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span> <span class="n">src_field</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                 <span class="n">dest_lon</span><span class="p">,</span> <span class="n">dest_lat</span><span class="p">,</span>
                                 <span class="n">pmap</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span>
                                 <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dest_mask</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nfield</span><span class="p">,</span> <span class="n">pmap</span></div>


<div class="viewcode-block" id="field3d"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.interp.field3d">[docs]</a><span class="k">def</span> <span class="nf">field3d</span><span class="p">(</span><span class="n">src_lon</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span> <span class="n">src_field</span><span class="p">,</span> <span class="n">dest_lon</span><span class="p">,</span> <span class="n">dest_lat</span><span class="p">,</span>
            <span class="n">dest_depth</span><span class="p">,</span> <span class="n">dest_mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a 3D field with time (dimensions [time, z, lat, lon]), interpolate</span>
<span class="sd">    onto a new grid and return the new field. This is a helper function</span>
<span class="sd">    when needing to interpolate data within files, etc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_lon: numpy.ndarray</span>
<span class="sd">        longitude that field is on</span>
<span class="sd">    src_lat: numpy.ndarray</span>
<span class="sd">        latitude that field is on</span>
<span class="sd">    srf_depth: numpy.ndarray</span>
<span class="sd">        depths of the field</span>
<span class="sd">    src_field: numpy.ndarray</span>
<span class="sd">        field to interpolate</span>
<span class="sd">    dest_lon: numpy.ndarray</span>
<span class="sd">        output longitudes to interpolate to</span>
<span class="sd">    dest_lat: numpy.ndarray</span>
<span class="sd">        output latitudes to interpolate to</span>
<span class="sd">    dest_depth: numpy.ndarray</span>
<span class="sd">        output depths to interpolate to</span>
<span class="sd">    dest_mask: numpy.ndarray, optional</span>
<span class="sd">        mask to apply to interpolated data</span>
<span class="sd">    reftime: datetime, optional:</span>
<span class="sd">        Reference time as the epoch for z-grid file</span>
<span class="sd">    nx : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    ny : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    weight : int, optional:</span>
<span class="sd">        number of points to use in weighting matrix</span>
<span class="sd">    threads : int, optional:</span>
<span class="sd">        number of processing threads</span>
<span class="sd">    pmap : numpy.ndarray, optional:</span>
<span class="sd">        use the specified pmap rather than compute it</span>

<span class="sd">    Output</span>
<span class="sd">    ------</span>
<span class="sd">    ndarray:</span>
<span class="sd">        interpolated field on the destination grid</span>
<span class="sd">    pmap:</span>
<span class="sd">        the pmap used in the inerpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">tmp</span><span class="p">,</span> <span class="n">pmap</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">oasurf</span><span class="p">(</span><span class="n">src_lon</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span>
                                 <span class="n">dest_lon</span><span class="p">,</span> <span class="n">dest_lat</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dest_mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dest_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dest_lat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">maxrecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">_max_memory</span> <span class="o">/</span> <span class="p">(</span><span class="n">dest_lon</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="n">dest_depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                                             <span class="n">src_lon</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">*</span> <span class="n">src_depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="n">recs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seapy</span><span class="o">.</span><span class="n">chunker</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">maxrecs</span><span class="p">)):</span>
        <span class="n">nfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                             <span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">__interp3_thread</span><span class="p">)(</span>
                                 <span class="n">src_lon</span><span class="p">,</span> <span class="n">src_lat</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span>
                                 <span class="n">src_field</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                 <span class="n">dest_lon</span><span class="p">,</span> <span class="n">dest_lat</span><span class="p">,</span> <span class="n">dest_depth</span><span class="p">,</span>
                                 <span class="n">pmap</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dest_mask</span><span class="p">,</span>
                                 <span class="n">up_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">down_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nfield</span><span class="p">,</span> <span class="n">pmap</span></div>


<div class="viewcode-block" id="to_zgrid"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.interp.to_zgrid">[docs]</a><span class="k">def</span> <span class="nf">to_zgrid</span><span class="p">(</span><span class="n">roms_file</span><span class="p">,</span> <span class="n">z_file</span><span class="p">,</span> <span class="n">z_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reftime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">cdlfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an existing ROMS history or average file, create (if does not exit)</span>
<span class="sd">    a new z-grid file. Use the given z_grid or otherwise build one with the</span>
<span class="sd">    same horizontal extent and the specified depths and interpolate the</span>
<span class="sd">    ROMS fields onto the z-grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    roms_file  : string,</span>
<span class="sd">        File name of src file to interpolate from</span>
<span class="sd">    z_file : string,</span>
<span class="sd">        Name of desination file to write to</span>
<span class="sd">    z_grid: (string or seapy.model.grid), optional:</span>
<span class="sd">        Name or instance of output definition</span>
<span class="sd">    depth: numpy.ndarray, optional:</span>
<span class="sd">        array of depths to use for z-level</span>
<span class="sd">    records : numpy.ndarray, optional:</span>
<span class="sd">        Record indices to interpolate</span>
<span class="sd">    threads : int, optional:</span>
<span class="sd">        number of processing threads</span>
<span class="sd">    reftime: datetime, optional:</span>
<span class="sd">        Reference time as the epoch for z-grid file</span>
<span class="sd">    nx : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    ny : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    weight : int, optional:</span>
<span class="sd">        number of points to use in weighting matrix</span>
<span class="sd">    vmap : dictionary, optional</span>
<span class="sd">        mapping source and destination variables</span>
<span class="sd">    cdlfile : string, optional</span>
<span class="sd">        cdlfile to use for generating the z-file</span>
<span class="sd">    dims : int, optional</span>
<span class="sd">        number of dimensions to use for lat/lon arrays (default 2)</span>
<span class="sd">    pmap : numpy.ndarray, optional:</span>
<span class="sd">        use the specified pmap rather than compute it</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pmap : ndarray</span>
<span class="sd">        the weighting matrix computed during the interpolation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">roms_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">roms_file</span><span class="p">)</span>
    <span class="n">ncroms</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf4</span><span class="p">(</span><span class="n">roms_file</span><span class="p">)</span>
    <span class="n">src_ref</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_reftime</span><span class="p">(</span><span class="n">ncroms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reftime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">src_ref</span> <span class="o">=</span> <span class="n">reftime</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
        <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="c1"># Load the grid</span>
    <span class="k">if</span> <span class="n">z_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">z_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">z_grid</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">z_file</span><span class="p">):</span>
        <span class="n">z_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">z_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">z_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">z_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;depth must be specified&quot;</span><span class="p">)</span>
            <span class="n">ncout</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_zlevel</span><span class="p">(</span><span class="n">z_file</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">src_ref</span><span class="p">,</span> <span class="s2">&quot;ROMS z-level&quot;</span><span class="p">,</span>
                                                   <span class="n">cdlfile</span><span class="o">=</span><span class="n">cdlfile</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">lat_rho</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">lon_rho</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">depth</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">roms_grid</span><span class="o">.</span><span class="n">mask_rho</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
            <span class="n">z_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">z_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">spatial_dims</span>
            <span class="n">ncout</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_zlevel</span><span class="p">(</span><span class="n">z_file</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">z_grid</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="n">src_ref</span><span class="p">,</span> <span class="s2">&quot;ROMS z-level&quot;</span><span class="p">,</span>
                                                   <span class="n">cdlfile</span><span class="o">=</span><span class="n">cdlfile</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">lat_rho</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">lon_rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">lat_rho</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">lon_rho</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">z</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">mask_rho</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ncout</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">z_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span>
        <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">][</span><span class="n">records</span><span class="p">],</span>
                         <span class="n">ncroms</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
        <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    <span class="n">ncroms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Call the interpolation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">roms_grid</span><span class="o">.</span><span class="n">set_east</span><span class="p">(</span><span class="n">z_grid</span><span class="o">.</span><span class="n">east</span><span class="p">())</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">__interp_grids</span><span class="p">(</span><span class="n">roms_grid</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">,</span> <span class="n">ncout</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">records</span><span class="p">,</span>
                              <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">vmap</span><span class="o">=</span><span class="n">vmap</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                              <span class="n">z_mask</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="n">pmap</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TimeoutError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Timeout: process is hung, deleting output.&quot;</span><span class="p">)</span>
        <span class="c1"># Delete the output file</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">z_file</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up</span>
        <span class="n">ncout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pmap</span></div>


<div class="viewcode-block" id="to_grid"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.interp.to_grid">[docs]</a><span class="k">def</span> <span class="nf">to_grid</span><span class="p">(</span><span class="n">src_file</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">,</span> <span class="n">dest_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">reftime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an existing model file, create (if does not exit) a</span>
<span class="sd">    new ROMS history file using the given ROMS destination grid and</span>
<span class="sd">    interpolate the ROMS fields onto the new grid. If an existing destination</span>
<span class="sd">    file is given, it is interpolated onto the specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_file  : string,</span>
<span class="sd">        Filename of src file to interpolate from</span>
<span class="sd">    dest_file : string,</span>
<span class="sd">        Name of desination file to write to</span>
<span class="sd">    dest_grid: (string or seapy.model.grid), optional:</span>
<span class="sd">        Name or instance of output definition</span>
<span class="sd">    records : numpy.ndarray, optional:</span>
<span class="sd">        Record indices to interpolate</span>
<span class="sd">    threads : int, optional:</span>
<span class="sd">        number of processing threads</span>
<span class="sd">    reftime: datetime, optional:</span>
<span class="sd">        Reference time as the epoch for ROMS file</span>
<span class="sd">    nx : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    ny : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    weight : int, optional:</span>
<span class="sd">        number of points to use in weighting matrix</span>
<span class="sd">    vmap : dictionary, optional</span>
<span class="sd">        mapping source and destination variables</span>
<span class="sd">    pmap : numpy.ndarray, optional:</span>
<span class="sd">        use the specified pmap rather than compute it</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pmap : ndarray</span>
<span class="sd">        the weighting matrix computed during the interpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dest_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">destg</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">dest_grid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_file</span><span class="p">):</span>
            <span class="n">ncsrc</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf4</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span>
            <span class="n">src_ref</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_reftime</span><span class="p">(</span><span class="n">ncsrc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reftime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">src_ref</span> <span class="o">=</span> <span class="n">reftime</span>
            <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
                <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
            <span class="n">ncout</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_ini</span><span class="p">(</span><span class="n">dest_file</span><span class="p">,</span>
                                                <span class="n">eta_rho</span><span class="o">=</span><span class="n">destg</span><span class="o">.</span><span class="n">eta_rho</span><span class="p">,</span> <span class="n">xi_rho</span><span class="o">=</span><span class="n">destg</span><span class="o">.</span><span class="n">xi_rho</span><span class="p">,</span> <span class="n">s_rho</span><span class="o">=</span><span class="n">destg</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                                                <span class="n">reftime</span><span class="o">=</span><span class="n">src_ref</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;interpolated from &quot;</span> <span class="o">+</span> <span class="n">src_file</span><span class="p">)</span>
            <span class="n">destg</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">ncout</span><span class="p">)</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ocean_time&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span>
                <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">][</span><span class="n">records</span><span class="p">],</span>
                                 <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
                <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;ocean_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="n">ncsrc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_file</span><span class="p">):</span>
        <span class="n">ncout</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">dest_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dest_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">destg</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>

    <span class="c1"># Call the interpolation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">src_grid</span><span class="o">.</span><span class="n">set_east</span><span class="p">(</span><span class="n">destg</span><span class="o">.</span><span class="n">east</span><span class="p">())</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">__interp_grids</span><span class="p">(</span><span class="n">src_grid</span><span class="p">,</span> <span class="n">destg</span><span class="p">,</span> <span class="n">ncout</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">records</span><span class="p">,</span>
                              <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                              <span class="n">vmap</span><span class="o">=</span><span class="n">vmap</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="n">pmap</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TimeoutError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Timeout: process is hung, deleting output.&quot;</span><span class="p">)</span>
        <span class="c1"># Delete the output file</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up</span>
        <span class="n">ncout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pmap</span></div>


<div class="viewcode-block" id="to_clim"><a class="viewcode-back" href="../../../modules/roms/index.html#seapy.roms.interp.to_clim">[docs]</a><span class="k">def</span> <span class="nf">to_clim</span><span class="p">(</span><span class="n">src_file</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">,</span> <span class="n">dest_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">reftime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an model output file, create (if does not exit) a</span>
<span class="sd">    new ROMS climatology file using the given ROMS destination grid and</span>
<span class="sd">    interpolate the ROMS fields onto the new grid. If an existing destination</span>
<span class="sd">    file is given, it is interpolated onto the specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_file  : string,</span>
<span class="sd">        Filename of src file to interpolate from</span>
<span class="sd">    dest_file : string,</span>
<span class="sd">        Name of desination file to write to</span>
<span class="sd">    dest_grid: (string or seapy.model.grid), optional:</span>
<span class="sd">        Name or instance of output definition</span>
<span class="sd">    records : numpy.ndarray, optional:</span>
<span class="sd">        Record indices to interpolate</span>
<span class="sd">    threads : int, optional:</span>
<span class="sd">        number of processing threads</span>
<span class="sd">    reftime: datetime, optional:</span>
<span class="sd">        Reference time as the epoch for climatology file</span>
<span class="sd">    nx : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    ny : float, optional:</span>
<span class="sd">        decorrelation length-scale for OA (same units as source data)</span>
<span class="sd">    weight : int, optional:</span>
<span class="sd">        number of points to use in weighting matrix</span>
<span class="sd">    vmap : dictionary, optional</span>
<span class="sd">        mapping source and destination variables</span>
<span class="sd">    pmap : numpy.ndarray, optional:</span>
<span class="sd">        use the specified pmap rather than compute it</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pmap : ndarray</span>
<span class="sd">        the weighting matrix computed during the interpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dest_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">destg</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">dest_grid</span><span class="p">)</span>
        <span class="n">src_grid</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">asgrid</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span>
        <span class="n">ncsrc</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">netcdf4</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span>
        <span class="n">src_ref</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">get_reftime</span><span class="p">(</span><span class="n">ncsrc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reftime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">src_ref</span> <span class="o">=</span> <span class="n">reftime</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
            <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="n">ncout</span> <span class="o">=</span> <span class="n">seapy</span><span class="o">.</span><span class="n">roms</span><span class="o">.</span><span class="n">ncgen</span><span class="o">.</span><span class="n">create_clim</span><span class="p">(</span><span class="n">dest_file</span><span class="p">,</span>
                                             <span class="n">eta_rho</span><span class="o">=</span><span class="n">destg</span><span class="o">.</span><span class="n">ln</span><span class="p">,</span> <span class="n">xi_rho</span><span class="o">=</span><span class="n">destg</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="n">s_rho</span><span class="o">=</span><span class="n">destg</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                                             <span class="n">ntimes</span><span class="o">=</span><span class="n">records</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">reftime</span><span class="o">=</span><span class="n">src_ref</span><span class="p">,</span>
                                             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;interpolated from &quot;</span> <span class="o">+</span> <span class="n">src_file</span><span class="p">)</span>
        <span class="n">src_time</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">][</span><span class="n">records</span><span class="p">],</span>
                                    <span class="n">ncsrc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dtime</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;zeta&quot;</span><span class="p">,</span> <span class="s2">&quot;v2d&quot;</span><span class="p">,</span> <span class="s2">&quot;v3d&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;salt&quot;</span><span class="p">):</span>
            <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">dtime</span> <span class="o">+</span> <span class="s2">&quot;_time&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">src_time</span><span class="p">,</span>
                                                                   <span class="n">ncout</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">dtime</span> <span class="o">+</span> <span class="s2">&quot;_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">ncsrc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s2">&quot;you must supply a destination file or a grid to make the file&quot;</span><span class="p">)</span>

    <span class="c1"># Call the interpolation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">src_grid</span><span class="o">.</span><span class="n">set_east</span><span class="p">(</span><span class="n">destg</span><span class="o">.</span><span class="n">east</span><span class="p">())</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">__interp_grids</span><span class="p">(</span><span class="n">src_grid</span><span class="p">,</span> <span class="n">destg</span><span class="p">,</span> <span class="n">ncout</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="n">records</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">,</span>
                              <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">vmap</span><span class="o">=</span><span class="n">vmap</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">pmap</span><span class="o">=</span><span class="n">pmap</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TimeoutError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Timeout: process is hung, deleting output.&quot;</span><span class="p">)</span>
        <span class="c1"># Delete the output file</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest_file</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up</span>
        <span class="n">ncout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pmap</span></div>
<span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">seapy 1.0a1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Powell Lab.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>